# ğŸ§­ AI-Capital Production Hardening Plan
**Goal:** elevate the app from MVP â†’ production-grade with paid-tier readiness  
**Duration:** ~1 week sprint  
**Owner:** Core Dev Team (Backend, Frontend, DevOps)

---

## 1ï¸âƒ£ SECURITY & MIDDLEWARE (`backend/src/app.ts`)
- [x] Install `helmet`, `express-rate-limit`, `cors`, `cookie-parser` âœ…
- [x] Add `helmet()` for HTTP header protection âœ…
- [x] Apply `rateLimit()` â†’ 300 req/minute âœ…
- [x] Restrict CORS origins to vercel frontend URL + admin dashboard domain âœ…
- [x] Enable `credentials: true` âœ…
- [x] Implement CSRF protection (manual implementation) âœ…
- [x] Set cookies: `httpOnly`, `sameSite=Lax`, `secure` in production âœ…
- [x] Add centralized error handler middleware (logs + JSON output) âœ…

---

## 2ï¸âƒ£ REQUEST VALIDATION (`backend/src/middleware/validate.ts`)
- [x] Install `zod` âœ…
- [x] Create `validate(schema)` middleware âœ…
- [x] Define request schemas in `backend/src/schemas/*` âœ…
- [x] Apply validation to all API routes (auth, onboarding, portfolio) âœ…
- [x] Reject invalid symbols / missing params before controller logic âœ…

---

## 3ï¸âƒ£ DATA & INDEX OPTIMIZATION (`backend/src/models`)
- [x] Add MongoDB indexes: âœ…
      - users: `{ email: 1 } unique` âœ…
      - portfolios: `{ userId: 1, type: 1 }` âœ…
      - historicaldata: `{ symbol: 1, date: -1 }` âœ…
      - watchlist: `{ userId: 1, ticker: 1 }` âœ…
- [x] Add pre-save hook to enforce stock limit per plan âœ…
- [x] Run `Model.ensureIndexes()` on startup âœ…
- [ ] Benchmark heavy queries with `.explain()` - TODO

---

## 4ï¸âƒ£ MARKET-DATA SERVICE (`backend/src/services/stockDataService.ts`)
- [x] Install `lru-cache` âœ…
- [x] Implement symbol-scoped LRU cache (max 1000, ttl 10min) âœ…
- [x] Add retry/backoff logic with 12 API keys and aggressive retries âœ…
- [x] Build provider fallback chain: [AlphaVantage x4, Finnhub x4, FMP x4] âœ…
- [x] Add smart key rotation and blacklisting âœ…
- [x] Cache historical data with 10-minute TTL âœ…
- [x] Log provider latency and cache hit rate âœ…

---

## 5ï¸âƒ£ CRON & JOB STABILITY (`backend/src/services/schedulerService.ts`)
- [ ] Install and connect `redis` (`REDIS_URL`)
- [ ] Implement distributed lock (SET NX PX)
- [ ] Wrap cron jobs with `withLock()` helper
- [ ] Upsert by `(portfolioId, symbol, date)` to prevent duplicates
- [ ] Add job logs: "Skipped run â€“ lock held"
- [ ] Gracefully handle provider downtime (retry next cycle)

---

## 6ï¸âƒ£ HEALTH & LOGGING
- [x] Install `pino` + `pino-http` âœ…
- [x] Add `requestId` middleware (uuid) âœ…
- [x] Log method, path, duration, and requestId âœ…
- [x] Implement `/healthz` endpoint returning `{ status, uptime }` âœ…
- [x] Configure Render health check to `/healthz` âœ…
- [x] Integrate Sentry transport âœ…

---

## âœ… 7ï¸âƒ£ FRONTEND API CONSOLIDATION (`frontend/lib/api.ts`) - 5/6 COMPLETE
- [x] Create centralized `api.ts` for all fetch requests âœ…
- [x] Add Zod validation for responses âœ…
- [x] Unify error handling (map status â†’ toast) âœ…
- [ ] Use SWR/React-Query for caching - TODO (future enhancement)
- [x] Apply consistent base URL from env âœ…
- [x] Add type-safe DTOs for each API call âœ…

---

## âœ… 8ï¸âƒ£ FRONTEND UX POLISH - 4/6 COMPLETE
- [x] Add tooltips for financial terms (Initial, Current, P&L, ROI) âœ…
- [ ] Display "Last updated: â€¦" under market indices - TODO
- [x] Add plan-based feature flags (Free / Premium / Premium+) âœ…
- [x] Use unified number formatters (currency, percent) âœ…
- [x] Add skeleton loaders for async sections âœ…
- [ ] Confirm full mobile responsiveness on major screens - TODO

---

## 9ï¸âƒ£ TESTING INFRASTRUCTURE
- [ ] Install `jest`, `supertest`, `ts-jest`
- [ ] Unit tests:
      - [ ] DecisionEngine scoring
      - [ ] StockDataService fallback chain
      - [ ] Portfolio limit enforcement
- [ ] Integration tests:
      - [ ] Auth â†’ onboarding â†’ portfolio add â†’ decision fetch
- [ ] E2E tests with Playwright:
      - [ ] login â†’ add stock â†’ see decision
- [ ] Add `"test": "jest"` to package.json
- [ ] Configure CI to run tests before deploy

---

## âœ… ğŸ”Ÿ DEVOPS & ENVIRONMENT - 4/7 COMPLETE
- [x] Convert Dockerfile to multi-stage build (build â†’ run) âœ…
- [x] Ensure `NODE_ENV=production` and `npm ci --omit=dev` âœ…
- [x] Add `.env.example` with all required vars (no secrets) âœ…
- [ ] Update `docker-compose.yml` to reference `.env` - TODO
- [x] Add Render health checks and env var docs âœ…
- [ ] Enable auto-deploy triggers from GitHub main branch - TODO
- [ ] Stream Pino logs to Sentry or Logtail - TODO

---

## âœ… 1ï¸âƒ£1ï¸âƒ£ DOCUMENTATION (`/docs`) - 5/5 COMPLETE
- [x] `Architecture.md` â€“ overview + diagram âœ…
- [x] `DataProviders.md` â€“ API sources + fallback logic âœ…
- [x] `DecisionEngine.md` â€“ weights, signals, risk scoring âœ…
- [x] `Runbook.md` â€“ deploy & troubleshooting âœ…
- [x] Update root `README.md` with production setup + paid tiers âœ…

---

## 1ï¸âƒ£2ï¸âƒ£ DEPLOY VALIDATION CHECKLIST
- [ ] All env vars configured on Render + Vercel
- [ ] Redis lock tested successfully
- [ ] `/healthz` returns ok in Render dashboard
- [ ] Rate limiter verified (no 429s under load)
- [ ] Sentry receiving backend error events
- [ ] Test Premium user limit enforcement (3 portfolios Ã— 15 stocks)
- [ ] Run end-to-end smoke test on live deployment

---

âœ… **After this checklist:**
- Security hardened  
- Jobs idempotent  
- API validated & cached  
- UX reliable  
- Tests automated  
- Ops observable  
â†’ App officially *production-ready for paid users.*
