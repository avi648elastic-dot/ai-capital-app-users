# üß≠ AI-Capital Production Hardening Plan
**Goal:** elevate the app from MVP ‚Üí production-grade with paid-tier readiness  
**Duration:** ~1 week sprint  
**Owner:** Core Dev Team (Backend, Frontend, DevOps)

---

## 1Ô∏è‚É£ SECURITY & MIDDLEWARE (`backend/src/app.ts`)
- [ ] Install `helmet`, `express-rate-limit`, `cors`, `cookie-parser`
- [ ] Add `helmet()` for HTTP header protection
- [ ] Apply `rateLimit()` ‚Üí 300 req/minute
- [ ] Restrict CORS origins to:
      - vercel frontend URL  
      - admin dashboard domain
- [ ] Enable `credentials: true`
- [ ] Implement CSRF protection (double submit or `csurf`)
- [ ] Set cookies: `httpOnly`, `sameSite=Lax`, `secure` in production
- [ ] Add centralized error handler middleware (logs + JSON output)

---

## 2Ô∏è‚É£ REQUEST VALIDATION (`backend/src/middleware/validate.ts`)
- [ ] Install `zod`
- [ ] Create `validate(schema)` middleware
- [ ] Define request schemas in `backend/src/schemas/*`
- [ ] Apply validation to all API routes (auth, onboarding, portfolio)
- [ ] Reject invalid symbols / missing params before controller logic

---

## 3Ô∏è‚É£ DATA & INDEX OPTIMIZATION (`backend/src/models`)
- [ ] Add MongoDB indexes:
      - users: `{ email: 1 } unique`
      - portfolios: `{ userId: 1, type: 1 }`
      - historicaldata: `{ symbol: 1, date: -1 }`
- [ ] Add pre-save hook to enforce stock limit per plan
- [ ] Run `Model.ensureIndexes()` on startup
- [ ] Benchmark heavy queries with `.explain()`

---

## 4Ô∏è‚É£ MARKET-DATA SERVICE (`backend/src/services/stockDataService.ts`)
- [ ] Install `lru-cache`
- [ ] Implement symbol-scoped LRU cache (max 2000, ttl 20s)
- [ ] Add retry/backoff logic (3 tries, 500ms delay)
- [ ] Build provider fallback chain: [finnhub, alphaVantage, yahoo]
- [ ] Add circuit breaker (disable provider on repeated errors)
- [ ] Cache historical data; only request deltas
- [ ] Log provider latency and cache hit rate

---

## 5Ô∏è‚É£ CRON & JOB STABILITY (`backend/src/services/schedulerService.ts`)
- [ ] Install and connect `redis` (`REDIS_URL`)
- [ ] Implement distributed lock (SET NX PX)
- [ ] Wrap cron jobs with `withLock()` helper
- [ ] Upsert by `(portfolioId, symbol, date)` to prevent duplicates
- [ ] Add job logs: "Skipped run ‚Äì lock held"
- [ ] Gracefully handle provider downtime (retry next cycle)

---

## 6Ô∏è‚É£ HEALTH & LOGGING
- [ ] Install `pino` + `pino-http`
- [ ] Add `requestId` middleware (uuid)
- [ ] Log method, path, duration, and requestId
- [ ] Implement `/healthz` endpoint returning `{ status, uptime }`
- [ ] Configure Render health check to `/healthz`
- [ ] Integrate optional Sentry or Logtail transport

---

## 7Ô∏è‚É£ FRONTEND API CONSOLIDATION (`frontend/lib/api.ts`)
- [ ] Create centralized `api.ts` for all fetch requests
- [ ] Add Zod validation for responses
- [ ] Unify error handling (map status ‚Üí toast)
- [ ] Use SWR/React-Query for caching
- [ ] Apply consistent base URL from env
- [ ] Add type-safe DTOs for each API call

---

## 8Ô∏è‚É£ FRONTEND UX POLISH
- [ ] Add tooltips for "This month %" vs "Last month %"
- [ ] Display "Last updated: ‚Ä¶" under market indices
- [ ] Add plan-based feature flags (Free / Premium / Premium+)
- [ ] Use unified number formatters (currency, percent)
- [ ] Add skeleton loaders for async sections
- [ ] Confirm full mobile responsiveness on major screens

---

## 9Ô∏è‚É£ TESTING INFRASTRUCTURE
- [ ] Install `jest`, `supertest`, `ts-jest`
- [ ] Unit tests:
      - [ ] DecisionEngine scoring
      - [ ] StockDataService fallback chain
      - [ ] Portfolio limit enforcement
- [ ] Integration tests:
      - [ ] Auth ‚Üí onboarding ‚Üí portfolio add ‚Üí decision fetch
- [ ] E2E tests with Playwright:
      - [ ] login ‚Üí add stock ‚Üí see decision
- [ ] Add `"test": "jest"` to package.json
- [ ] Configure CI to run tests before deploy

---

## üîü DEVOPS & ENVIRONMENT
- [ ] Convert Dockerfile to multi-stage build (build ‚Üí run)
- [ ] Ensure `NODE_ENV=production` and `npm ci --omit=dev`
- [ ] Add `.env.example` with all required vars (no secrets)
- [ ] Update `docker-compose.yml` to reference `.env`
- [ ] Add Render health checks and env var docs
- [ ] Enable auto-deploy triggers from GitHub main branch
- [ ] Stream Pino logs to Sentry or Logtail

---

## 1Ô∏è‚É£1Ô∏è‚É£ DOCUMENTATION (`/docs`)
- [ ] `Architecture.md` ‚Äì overview + diagram
- [ ] `DataProviders.md` ‚Äì API sources + fallback logic
- [ ] `DecisionEngine.md` ‚Äì weights, signals, risk scoring
- [ ] `Runbook.md` ‚Äì deploy & troubleshooting
- [ ] Update root `README.md` with production setup + paid tiers

---

## 1Ô∏è‚É£2Ô∏è‚É£ DEPLOY VALIDATION CHECKLIST
- [ ] All env vars configured on Render + Vercel
- [ ] Redis lock tested successfully
- [ ] `/healthz` returns ok in Render dashboard
- [ ] Rate limiter verified (no 429s under load)
- [ ] Sentry receiving backend error events
- [ ] Test Premium user limit enforcement (3 portfolios √ó 15 stocks)
- [ ] Run end-to-end smoke test on live deployment

---

‚úÖ **After this checklist:**
- Security hardened  
- Jobs idempotent  
- API validated & cached  
- UX reliable  
- Tests automated  
- Ops observable  
‚Üí App officially *production-ready for paid users.*
